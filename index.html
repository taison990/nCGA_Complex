<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NGL Viewer with Trajectory and Controls</title>
  <script src="https://cdn.jsdelivr.net/npm/ngl@2.0.0-dev.39/dist/ngl.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dat.gui@0.7.9/build/dat.gui.min.js"></script>
  <style>
    body { margin: 0; overflow: hidden; }
    #viewport { width: 100vw; height: 100vh; }
    .dg { position: absolute; top: 0; right: 0; z-index: 100; }
  </style>
</head>
<body>
  <div id="viewport"></div>
  <script>
    const stage = new NGL.Stage("viewport");

    const settings = {
      representation: 'cartoon',
      colorScheme: 'element',
      opacity: 1.0,
      spin: false,
      resetView: () => stage.autoView(),
      play: false,
      speed: 1.0,
      frame: 0
    };

    let comp = null;
    let traj = null;
    let animationFrameId = null;

    stage.loadFile("https://raw.githubusercontent.com/taison990/nCGA_Complex/master/all_start.pdb", {
      defaultRepresentation: false
    }).then(function (structureComponent) {
      comp = structureComponent;
      comp.addRepresentation(settings.representation, {
        colorScheme: settings.colorScheme,
        opacity: settings.opacity
      });
      comp.autoView();

      // 載入 xtc 軌跡檔
      comp.addTrajectory("https://zenodo.org/records/15358478/files/md_0_10_fit.xtc?download=1")
        .then(function (trajectory) {
          traj = trajectory;
          traj.setParameters({ step: 1 });
          settings.frame = 0;
          createGUI();
        });
    });

    function createGUI() {
      const gui = new dat.GUI();

      gui.add(settings, 'representation', ['cartoon', 'ball+stick', 'surface', 'licorice']).onChange(updateRepresentation);
      gui.add(settings, 'colorScheme', ['element', 'chainid', 'residueindex', 'bfactor']).onChange(updateRepresentation);
      gui.add(settings, 'opacity', 0, 1).step(0.01).onChange(updateRepresentation);
      gui.add(settings, 'spin').onChange(val => stage.setSpin(val));
      gui.add(settings, 'resetView');
      gui.add(settings, 'play').onChange(val => val ? playTrajectory() : pauseTrajectory());
      gui.add(settings, 'speed', 0.1, 5).step(0.1);
      gui.add(settings, 'frame', 0, 2002).step(1).onChange(val => {
        if (traj) {
          traj.setFrame(val);
        }
      });
    }

    function updateRepresentation() {
      if (comp) {
        comp.removeAllRepresentations();
        comp.addRepresentation(settings.representation, {
          colorScheme: settings.colorScheme,
          opacity: settings.opacity
        });
      }
    }

    function playTrajectory() {
      function animate() {
        if (traj && traj.numframes > 0) {
          settings.frame = (settings.frame + 1) % traj.numframes;
          traj.setFrame(settings.frame);
        }
        animationFrameId = requestAnimationFrame(animate);
      }
      animate();
    }

    function pauseTrajectory() {
      if (animationFrameId !== null) {
        cancelAnimationFrame(animationFrameId);
        animationFrameId = null;
      }
    }
  </script>
</body>
</html>
