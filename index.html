<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NGL Viewer with Trajectory and Controls</title>
  <script src="https://cdn.jsdelivr.net/npm/ngl@2.0.0-dev.39/dist/ngl.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dat.gui@0.7.9/build/dat.gui.min.js"></script>
  <style>
    body { margin: 0; overflow: hidden; }
    #viewport { width: 100vw; height: 100vh; }
    .dg { position: absolute; top: 0; right: 0; z-index: 100; }
  </style>
</head>

<body>
  <div id="viewport"></div>

  <script>
    var stage = new NGL.Stage("viewport");

    stage.loadFile("https://raw.githubusercontent.com/taison990/nCGA_Complex/master/all_start.pdb")
      .then(function (o) {
        o.addRepresentation("ball+stick");
        o.autoView();

        // 加載軌跡檔案 (xtc)
        var traj = null;
        stage.loadFile("https://zenodo.org/records/15358478/files/md_0_10_fit.xtc?download=1", { defaultRepresentation: true })
          .then(function (file) {
            traj = file;
            traj.addRepresentation("cartoon");
            traj.autoView();
          });

        var gui = new dat.GUI();
        var settings = {
          representation: 'ball+stick',
          colorScheme: 'element',
          opacity: 1.0,
          spin: false,
          resetView: function () { stage.autoView(); },
          play: false,
          speed: 1.0,
          frame: 0,
        };

        var rep;

        function updateRepresentation() {
          o.removeAllRepresentations();
          rep = o.addRepresentation(settings.representation, {
            colorScheme: settings.colorScheme,
            opacity: settings.opacity
          });
        }

        gui.add(settings, 'representation', ['cartoon', 'ball+stick', 'surface', 'licorice']).onChange(updateRepresentation);
        gui.add(settings, 'colorScheme', ['element', 'chainid', 'residueindex', 'bfactor']).onChange(updateRepresentation);
        gui.add(settings, 'opacity', 0, 1).step(0.01).onChange(updateRepresentation);
        gui.add(settings, 'spin').onChange(function (value) {
          stage.setSpin(value);
        });
        gui.add(settings, 'resetView');

        // 播放/暫停控制
        gui.add(settings, 'play').onChange(function(value) {
          if (value) {
            playTrajectory();
          } else {
            pauseTrajectory();
          }
        });

        // 播放速度控制
        gui.add(settings, 'speed', 0.1, 5).step(0.1).onChange(function(value) {
          if (traj) {
            traj.playbackSpeed = value;
          }
        });

        // 顯示的步長控制
        gui.add(settings, 'frame', 0, 100).step(1).onChange(function(value) {
          if (traj) {
            traj.frame = value;
            traj.update();
          }
        });

        updateRepresentation();

        // 動畫播放與控制邏輯
        var animationFrameId = null;
        function playTrajectory() {
          (function animate() {
            if (traj) {
              if (traj.frame < traj.frames) {
                traj.frame++;
                traj.update();
              } else {
                traj.frame = 0;
              }
            }
            animationFrameId = requestAnimationFrame(animate);
          })();
        }

        function pauseTrajectory() {
          if (animationFrameId !== null) {
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
          }
        }
      });
  </script>
</body>
</html>
